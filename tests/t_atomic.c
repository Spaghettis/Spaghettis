
/* Copyright (c) 1997-2017 Miller Puckette and others. */

/* < https://opensource.org/licenses/BSD-3-Clause > */

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

/* < https://github.com/mintomic/mintomic/tree/master/tests > */

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

static t_int32Atomic    test_int32Shared;
static t_uint32Atomic   test_uInt32Shared;
static t_uint64Atomic   test_uInt64Shared;

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

void *test_increment (void *x)
{
    int i, n = (int)(long)x;
    TTTWaste w;
    
    ttt_wasteInit (&w, n);
    
    if ((n % 2) == 0) {
    //
    for (i = 0; i < 1000000; i++) {
        PD_ATOMIC_INT32_INCREMENT (&test_int32Shared);
        // test_int32Shared++;
        ttt_wasteTime (&w);
    }
    //
    } else {
    //
    for (i = 0; i < 1000000; i++) {
        PD_ATOMIC_INT32_DECREMENT (&test_int32Shared);
        ttt_wasteTime (&w);
    }
    //
    }
    
    return NULL;
}

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#if 0
void test10__increment() {    /* Increment / Decrement. */
#endif

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

TTT_BEGIN (AtomicIncrement, 10, "Atomic - Increment")

    if (ttt_testThreadsLaunch (test_increment) != TTT_GOOD) { TTT_FAIL; }
    else {
        int t = PD_ATOMIC_INT32_READ (&test_int32Shared); TTT_EXPECT (t == 0);
    }

TTT_END

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#if 0
}
#endif

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
