
/* < https://opensource.org/licenses/BSD-3-Clause > */

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

void test_doSomething (t_rand48 *rnd, tll_algorithm *a)
{
    int i, k = tll_randomGetInteger (rnd, 37);
    int argc = (k % 8) + 1;
    int argv[8] = { 0 };
    
    if (!k) { tll_algorithmClear (a); }
    else {
    //
    tll_algorithmProceed (a, argc, argv);
    for (i = 0; i < argc; i++) { argv[i] = tll_randomGetInteger (rnd, 128); }
    tll_algorithmAdd (a, argc, argv);
    //
    }
}

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

#if 0
void test200__random() {
#endif

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

TTT_BEGIN (TralalaRandom, 200, "Tralala - Random")

    int i, j, type;
    
    t_rand48 *rnd = tll_randomNew();
    
    for (i = 0; i < 10; i++) {
    for (type = 0; type < TLL_ALGORITHM_TYPE_SIZE; type++) {
    
        tll_algorithm *a = TLL_ALGORITHM_NEW (type, rnd);
        for (j = 0; j < 1000; j++) { test_doSomething (rnd, a); }
        tll_algorithmFree (a);
    }
    }
    
    tll_randomFree (rnd);
    
TTT_END

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#if 0
}
#endif

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#if 0
void test201__serialize() {
#endif

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

TTT_BEGIN (TralalaSerialize, 201, "Tralala - Serialize")
    
    int j, t, type;
    
    t_rand48 *rnd = tll_randomNew();
    
    for (type = 0; type < TLL_ALGORITHM_TYPE_SIZE; type++) {

        tll_algorithm *a = TLL_ALGORITHM_NEW (type, rnd);
        
        for (j = 0; j < 1000; j++) {
            test_doSomething (rnd, a);
            tll_array *t1 = tll_algorithmSerialize (a); test_doSomething (rnd, a);
            t_error   err = tll_algorithmDeserialize (a, t1);
            tll_array *t2 = tll_algorithmSerialize (a);
            int m = tll_arrayGetSize (t1);
            int n = tll_arrayGetSize (t2);
            TTT_EXPECT (err == PD_ERROR_NONE);
            if (m != n) { TTT_FAIL; }
            else {
                for (t = 0; t < m; t++) {
                    TTT_EXPECT (tll_arrayGetAtIndex (t1, t) == tll_arrayGetAtIndex (t2, t));
                }
            }
            tll_arrayFree (t1);
            tll_arrayFree (t2);
        }
        
        tll_algorithmFree (a);
    }
    
    tll_randomFree (rnd);
    
TTT_END

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#if 0
}
#endif

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

static int test_latticeData[24] =
    {
        1, 3, 6, 8,
        1, 3, 7, 9,
        1, 4, 7, 9,
        2, 3, 6, 8,
        2, 2, 5, 7,
        2, 3, 6, 9
    };

static int test_latticeExpected[267] =
    {
        15,
        50,
        -1,
        -1,
        19,
        0,
        0,
        5,
        5,
        8,
        11,
        12,
        14,
        5,
        1,
        2,
        1,
        3,
        6,
        8,
        1,
        3,
        3,
        3,
        15,
        16,
        11,
        1,
        2,
        7,
        6,
        13,
        12,
        1,
        2,
        2,
        13,
        17,
        14,
        1,
        2,
        9,
        6,
        16,
        3,
        2,
        2,
        1,
        3,
        2,
        4,
        15,
        2,
        2,
        3,
        6,
        9,
        17,
        16,
        2,
        2,
        3,
        9,
        4,
        18,
        6,
        3,
        2,
        1,
        7,
        9,
        4,
        7,
        9,
        3,
        2,
        3,
        6,
        8,
        2,
        10,
        13,
        3,
        1,
        2,
        5,
        7,
        1,
        17,
        3,
        2,
        2,
        3,
        6,
        10,
        18,
        2,
        4,
        1,
        1,
        3,
        6,
        8,
        1,
        4,
        4,
        1,
        1,
        3,
        7,
        9,
        1,
        7,
        4,
        1,
        1,
        4,
        7,
        9,
        1,
        10,
        4,
        1,
        2,
        3,
        6,
        8,
        1,
        18,
        4,
        1,
        2,
        3,
        6,
        9,
        1,
        1,
        128,
        0,
        0,
        1,
        2,
        3,
        4,
        5,
        6,
        7,
        8,
        9,
        10,
        11,
        12,
        13,
        14,
        15,
        16,
        17,
        18,
        19,
        20,
        21,
        22,
        23,
        24,
        25,
        26,
        27,
        28,
        29,
        30,
        31,
        32,
        33,
        34,
        35,
        36,
        37,
        38,
        39,
        40,
        41,
        42,
        43,
        44,
        45,
        46,
        47,
        48,
        49,
        50,
        51,
        52,
        53,
        54,
        55,
        56,
        57,
        58,
        59,
        60,
        61,
        62,
        63,
        64,
        65,
        66,
        67,
        68,
        69,
        70,
        71,
        72,
        73,
        74,
        75,
        76,
        77,
        78,
        79,
        80,
        81,
        82,
        83,
        84,
        85,
        86,
        87,
        88,
        89,
        90,
        91,
        92,
        93,
        94,
        95,
        96,
        97,
        98,
        99,
        100,
        101,
        102,
        103,
        104,
        105,
        106,
        107,
        108,
        109,
        110,
        111,
        112,
        113,
        114,
        115,
        116,
        117,
        118,
        119,
        120,
        121,
        122,
        123,
        124,
        125,
        126,
        127
    };

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#if 0
void test202__lattice() {
#endif

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

TTT_BEGIN (TralalaLattice, 202, "Tralala - Lattice")

    t_rand48 *rnd = tll_randomNewWithSeed (0x1234);
    tll_algorithm *a = TLL_ALGORITHM_NEW (TLL_ALGORITHM_TYPE_LATTICE, rnd);
    int i;
    
    for (i = 0; i < 24; i += 4) { tll_algorithmAdd (a, 4, test_latticeData + i); }
    
    tll_array *t = tll_algorithmSerialize (a);
    
    if (tll_arrayGetSize (t) != 267 + 5) { TTT_FAIL; }
    else {
    //
    for (i = 0; i < 267; i++) {
        TTT_EXPECT (tll_arrayGetAtIndex (t, i) == test_latticeExpected[i]);
    }
    //
    }
    
    tll_arrayFree (t);
    tll_algorithmFree (a);
    tll_randomFree (rnd);
    
TTT_END

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#if 0
}
#endif

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

static int test_oracleData[11] = { 10, 20, 20, 30, 10, 20, 30, 40, 10, 20, 30 };

static int test_oracleExpected[74] =
    {
        0,
        2,
        255,
        128,
        25,
        12,
        -1,
        0,
        4,
        1,
        10,
        2,
        20,
        4,
        30,
        8,
        40,
        0,
        0,
        1,
        2,
        20,
        0,
        0,
        2,
        3,
        20,
        4,
        30,
        2,
        1,
        1,
        4,
        30,
        0,
        0,
        2,
        5,
        10,
        8,
        40,
        1,
        1,
        1,
        6,
        20,
        2,
        2,
        1,
        7,
        30,
        4,
        2,
        1,
        8,
        40,
        0,
        0,
        1,
        9,
        10,
        1,
        1,
        1,
        10,
        20,
        2,
        2,
        1,
        11,
        30,
        4,
        2,
        0
    };

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#if 0
void test203__oracle() {
#endif

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

TTT_BEGIN (TralalaOracle, 203, "Tralala - Oracle")

    t_rand48 *rnd = tll_randomNewWithSeed (0x1234);
    tll_algorithm *a = TLL_ALGORITHM_NEW (TLL_ALGORITHM_TYPE_ORACLE, rnd);
    int i;
    
    tll_algorithmAdd (a, 11, test_oracleData);
    
    tll_array *t = tll_algorithmSerialize (a);
    
    if (tll_arrayGetSize (t) != 74 + 5) { TTT_FAIL; }
    else {
    //
    for (i = 0; i < 74; i++) {
        TTT_EXPECT (tll_arrayGetAtIndex (t, i) == test_oracleExpected[i]);
    }
    //
    }
    
    tll_arrayFree (t);
    tll_algorithmFree (a);
    tll_randomFree (rnd);
    
TTT_END

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#if 0
}
#endif

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

#if 0
void test204__hash() {
#endif

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

TTT_BEGIN (TralalaHash, 204, "Tralala - Hash")

    t_rand48 *rnd = tll_randomNew();
    
    tll_array *t = tll_arrayNew (0);
    
    int i;
    
    for (i = 0; i < 100; i++) {
    //
    tll_arrayClear (t);
    tll_arrayAppend (t, tll_randomGetInteger (rnd, TLL_ALPHABET));
    
    int j, m, n;
    uint32_t h, hash = tll_arrayHash (t);
    
    for (j = 0; j < 100; j++) {
        tll_arrayAppend (t, tll_randomGetInteger (rnd, TLL_ALPHABET));
        h = tll_arrayHash (t);
        TTT_EXPECT (h != hash);
        hash = h;
        n = tll_randomGetInteger (rnd, j + 1);
        m = tll_arrayGetAtIndex (t, n) + tll_randomGetInteger (rnd, TLL_ALPHABET) + 1;
        tll_arraySetAtIndex (t, n, m);
        h = tll_arrayHash (t);
        TTT_EXPECT (h != hash);
        hash = h;
    }
    //
    }
    
    tll_arrayFree (t);
    tll_randomFree (rnd);
    
TTT_END

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#if 0
}
#endif

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
