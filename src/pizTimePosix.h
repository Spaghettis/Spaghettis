
/* 
    Copyright (c) 2014, Nicolas Danet, < nicolas.danet@free.fr >. 
*/

/* < http://opensource.org/licenses/MIT > */

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

#ifndef PIZ_TIME_POSIX_H
#define PIZ_TIME_POSIX_H

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#include "m_spaghettis.h"
#include "m_core.h"
#include "s_system.h"

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#include "pizTypes.h"

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#include <time.h>
#include <sys/time.h>

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

typedef PIZUInt64 PIZTime;
typedef PIZUInt64 PIZNano;
typedef PIZUInt64 PIZStamp;

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

#define PIZ_ZERO_TIME   0ULL
#define PIZ_ZERO_NANO   0ULL
#define PIZ_ZERO_STAMP  0ULL

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

typedef struct _PIZBase {
    PIZTime         time_;
    struct timeval  tv_;
    } PIZBase; 

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

PIZUInt64   pizSeedMake             (void);
void        pizSeedConstant         (PIZBool isConstant);

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

/* Do NOT call pizTimeAddNano or pizTimeElapsedNano at initialization time. */

/* < http://www.parashift.com/c++-faq/static-init-order.html > */

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

void        pizTimeSet              (PIZTime *t);
void        pizTimeCopy             (PIZTime *t, const PIZTime *toCopy);
void        pizTimeAddNano          (PIZTime *t, const PIZNano *ns); 
PIZError    pizTimeElapsedNano      (const PIZTime *t0, const PIZTime *t1, PIZNano *r);
PIZUInt64   pizTimeAsUInt64         (PIZTime *t);
void        pizTimeWithUInt64       (PIZTime *t, PIZUInt64 n);
PIZBool     pizTimeIsEqual          (PIZTime *t1, PIZTime *t2);

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

void        pizNanoSleep            (PIZNano *ns);
void        pizNanoWithDouble       (PIZNano *ns, double f);
PIZUInt64   pizNanoAsUInt64         (PIZNano *ns);
PIZBool     pizNanoIsLessThan       (PIZNano *t1, PIZNano *t2);

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

/* < https://en.wikipedia.org/wiki/Network_Time_Protocol > */

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

void        pizStampSet             (PIZStamp *stamp);
void        pizStampCopy            (PIZStamp *stamp, const PIZStamp *toCopy);
void        pizStampAddNano         (PIZStamp *stamp, const PIZNano *ns);
PIZError    pizStampElapsedNano     (const PIZStamp *t0, const PIZStamp *t1, PIZNano *r);
PIZUInt64   pizStampAsUInt64        (PIZStamp *stamp);
void        pizStampWithUInt64      (PIZStamp *stamp, PIZUInt64 n);
PIZBool     pizStampIsEqual         (PIZStamp *t1, PIZStamp *t2);

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

PIZError    pizBaseInit             (PIZBase *base);
PIZError    pizBaseTimeToStamp      (const PIZBase *base, const PIZTime *t, PIZStamp *stamp);
PIZError    pizBaseStampToTime      (const PIZBase *base, const PIZStamp *stamp, PIZTime *t);

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
#endif // PIZ_TIME_POSIX_H
