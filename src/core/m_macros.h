
/* Copyright (c) 1997-2018 Miller Puckette and others. */

/* < https://opensource.org/licenses/BSD-3-Clause > */

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

#ifndef __m_macros_h_
#define __m_macros_h_

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

#define PD_SHORT_FILE       (strrchr (__FILE__, '/') ? strrchr (__FILE__, '/') + 1 : __FILE__)

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

#if PD_WITH_DEBUG

    #define PD_BUG          PD_ASSERT (0)
    #define PD_ASSERT(x)    if (!(x)) { post_log ("*** Assert / %s / line %d", PD_SHORT_FILE, __LINE__); }

#else
    
    #define PD_BUG
    #define PD_ASSERT(x)

#endif // PD_WITH_DEBUG

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

/* < https://locklessinc.com/articles/vectorize/ > */

#if PD_ASSUME_ALIGNED
    #define PD_RESTRICTED   t_sample* __restrict__
    #define PD_ALIGNED(x)   __builtin_assume_aligned((x), 16)
#else
    #define PD_RESTRICTED   t_sample*
    #define PD_ALIGNED(x)   (x)
#endif

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

#define PD_LIKELY(x)        __builtin_expect ((x), 1)
#define PD_UNLIKELY(x)      __builtin_expect ((x), 0)

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

#define PD_ATOMS_ALLOCA(x, n)  \
    (x) = (t_atom *)((n) < 64 ? alloca ((n) * sizeof (t_atom)) : PD_MEMORY_GET ((n) * sizeof (t_atom)))
        
#define PD_ATOMS_FREEA(x, n)   \
    if (n >= 64) { PD_MEMORY_FREE ((x)); }

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

#define PD_UNUSED(x)        (void)(x)

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#define PD_ABORT(x)         if (PD_UNLIKELY (x)) { abort(); }

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

/* Roughly every object that is not a scalar. */

#define cast_objectIfConnectable(x)         (class_isBox (pd_class (x)) ? (t_object *)(x) : NULL)

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

#define IS_SEMICOLON_OR_COMMA(atom)         ((IS_SEMICOLON(atom)) || (IS_COMMA(atom)))

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

#define WORD_FLOAT(w)                       ((w)->w_float)
#define WORD_SYMBOL(w)                      ((w)->w_symbol)
#define WORD_ARRAY(w)                       ((w)->w_array)

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

#define ADDRESS_FLOAT(atom)                 &((atom)->a_w.w_float)
#define ADDRESS_SYMBOL(atom)                &((atom)->a_w.w_symbol)

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

#define inlet_new2(x, type)                 inlet_new (cast_object ((x)), cast_pd ((x)), (type), sym__inlet2)
#define inlet_new3(x, type)                 inlet_new (cast_object ((x)), cast_pd ((x)), (type), sym__inlet3)

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

#define PD_INT_MAX                          0x7fffffff
#define PD_FLT_MAX                          DBL_MAX
#define PD_EPSILON                          1E-9

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

#define PD_IS_POWER_2(v)                    (!((v) & ((v) - 1)))
#define PD_NEXT_POWER_2(v)                  sys_nextPowerOfTwo ((uint64_t)(v))
#define PD_TO_RADIANS(degrees)              ((PD_PI * (degrees)) / 180.0)
#define PD_IS_ALIGNED_16(p)                 (((unsigned long)(p) & 0xfUL) == 0)

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

/* Notice that it returns zero with an argument of zero. */

static inline uint64_t sys_nextPowerOfTwo (uint64_t v)
{
    v--;
    v |= (v >> 1);
    v |= (v >> 2);
    v |= (v >> 4);
    v |= (v >> 8);
    v |= (v >> 16);
    v |= (v >> 32);
    v++;
    
    return v;
}

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

/* Assumed IEEE 754 floating-point format. */

typedef union {
    float       z_f;
    uint32_t    z_i;
    } t_rawcast32;

typedef union {
    double      z_d;
    uint32_t    z_i[2];
    uint64_t    z_l;
    } t_rawcast64;

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

/* < https://en.wikipedia.org/wiki/Endianness#Floating_point > */

#if PD_LITTLE_ENDIAN

    #define PD_RAWCAST64_MSB        1                                                              
    #define PD_RAWCAST64_LSB        0

#else
                                                                      
    #define PD_RAWCAST64_MSB        0
    #define PD_RAWCAST64_LSB        1

#endif // PD_LITTLE_ENDIAN

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

 /* True if zero, denormal, infinite, or NaN. */

static inline int PD_FLOAT32_IS_INVALID_OR_ZERO (float f)
{
    t_rawcast32 z;
    z.z_f = f;
    z.z_i &= 0x7f800000;
    return ((z.z_i == 0) || (z.z_i == 0x7f800000));
}

static inline int PD_FLOAT64_IS_INVALID_OR_ZERO (double f)
{
    t_rawcast64 z;
    z.z_d = f;
    z.z_i[PD_RAWCAST64_MSB] &= 0x7ff00000;
    return ((z.z_i[PD_RAWCAST64_MSB] == 0) || (z.z_i[PD_RAWCAST64_MSB] == 0x7ff00000));
}

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

/* True if exponent falls out (-64, 64) range. */

static inline int PD_FLOAT32_IS_BIG_OR_SMALL (float f)
{
    t_rawcast32 z;
    z.z_f = f;
    return ((z.z_i & 0x20000000) == ((z.z_i >> 1) & 0x20000000)); 
}

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

static inline int PD_FLOAT64_IS_INTEGER (double f)
{
    return (trunc (f) - f == 0.0);
}

static inline int PD_FLOAT32_IS_INTEGER (float f)
{
    return (truncf (f) - f == 0.0);
}

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
#endif // __m_macros_h_
